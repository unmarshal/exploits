#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>


#define _zero(x) memset(&(x), 0, sizeof(x));
#define _death(a) do{ perror(#a "()"); exit(-1); }while(0)

void
hexdump(char *desc, unsigned char *data, unsigned int amount)
{
	unsigned int dp, p;	/* data pointer */
	const char trans[] =
	"................................ !\"#$%&'()*+,-./0123456789"
	":;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklm"
	"nopqrstuvwxyz{|}~...................................."
	"....................................................."
	"........................................";


	for (dp = 1; dp <= amount; dp++) {
		fprintf(stderr, "%02x ", data[dp - 1]);
		if ((dp % 8) == 0)
			fprintf(stderr, " ");
		if ((dp % 16) == 0) {
			fprintf(stderr, "| ");
			p = dp;
			for (dp -= 16; dp < p; dp++)
				fprintf(stderr, "%c", trans[data[dp]]);
			fflush(stderr);
			fprintf(stderr, "\n");
		}
		fflush(stderr);
	}
	if ((amount % 16) != 0) {
		p = dp = 16 - (amount % 16);
		for (dp = p; dp > 0; dp--) {
			fprintf(stderr, "   ");
			if (((dp % 8) == 0) && (p != 8))
				fprintf(stderr, " ");
			fflush(stderr);
		}
		fprintf(stderr, " | ");
		for (dp = (amount - (16 - p)); dp < amount; dp++)
			fprintf(stderr, "%c", trans[data[dp]]);
		fflush(stderr);
	}
	fprintf(stderr, "\n");

	return;
}


int 
forward(int from, int to)
{
	char data[1024];
	int n, m;

	n = read(from, data, sizeof(data));
	if (!n)
		return (-1);
	if (n == -1)
		_death(read);
	m = write(to, data, n);
	if (m != n)
		_death(write);
	return (0);
}


int 
shell(int sd)
{
	int n, i;
	fd_set set;
	char data[4096];

	putchar('\n');

	write(sd, "/bin/uname -mnrsp; /usr/bin/id\n", 31);

	_zero(data);
	read(sd, data, sizeof(data));
	printf("%s", data);

	_zero(data);
	read(sd, data, sizeof(data));
	printf("%s", data);

	for (;;) {
		FD_ZERO(&set);
		FD_SET(0, &set);
		FD_SET(sd, &set);

		n = select(sd + 1, &set, NULL, NULL, NULL);
		if (n == -1)
			_death(select);

		if (FD_ISSET(0, &set))
			if (forward(0, sd))
				break;

		if (FD_ISSET(sd, &set))
			if (forward(sd, 1))
				break;
	}
	return (1);
}
